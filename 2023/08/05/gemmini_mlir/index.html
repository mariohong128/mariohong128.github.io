



<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#FFF">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">

<link rel="icon" type="image/ico" sizes="32x32" href="/images/favicon.ico">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">


<link rel="alternate" type="application/rss+xml" title="mariohong's blog" href="http://dodobird.top/rss.xml" />
<link rel="alternate" type="application/atom+xml" title="mariohong's blog" href="http://dodobird.top/atom.xml" />
<link rel="alternate" type="application/json" title="mariohong's blog" href="http://dodobird.top/feed.json" />

<link rel="stylesheet" href="//fonts.googleapis.com/css?family=Mulish:300,300italic,400,400italic,700,700italic%7CFredericka%20the%20Great:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20JP:300,300italic,400,400italic,700,700italic%7CNoto%20Serif%20SC:300,300italic,400,400italic,700,700italic%7CInconsolata:300,300italic,400,400italic,700,700italic&display=swap&subset=latin,latin-ext">

<link rel="stylesheet" href="/css/app.css?v=0.2.5">

  

<link rel="canonical" href="http://dodobird.top/2023/08/05/gemmini_mlir/">



  <title>
gemmini+mlir环境搭建与架构认识 |
mariohong's blog = mariohong's blog</title>
<meta name="generator" content="Hexo 6.3.0"></head>
<body itemscope itemtype="http://schema.org/WebPage">
  <div id="loading">
    <div class="cat">
      <div class="body"></div>
      <div class="head">
        <div class="face"></div>
      </div>
      <div class="foot">
        <div class="tummy-end"></div>
        <div class="bottom"></div>
        <div class="legs left"></div>
        <div class="legs right"></div>
      </div>
      <div class="paw">
        <div class="hands left"></div>
        <div class="hands right"></div>
      </div>
    </div>
  </div>
  <div id="container">
    <header id="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="inner">
        <div id="brand">
          <div class="pjax">
          
  <h1 itemprop="name headline">gemmini+mlir环境搭建与架构认识
  </h1>
  
<div class="meta">
  <span class="item" title="创建时间：2023-08-05 20:17:40">
    <span class="icon">
      <i class="ic i-calendar"></i>
    </span>
    <span class="text">发表于</span>
    <time itemprop="dateCreated datePublished" datetime="2023-08-05T20:17:40+08:00">2023-08-05</time>
  </span>
</div>


          </div>
        </div>
        <nav id="nav">
  <div class="inner">
    <div class="toggle">
      <div class="lines" aria-label="切换导航栏">
        <span class="line"></span>
        <span class="line"></span>
        <span class="line"></span>
      </div>
    </div>
    <ul class="menu">
      <li class="item title"><a href="/" rel="start">mariohong's blog</a></li>
    </ul>
    <ul class="right">
      <li class="item theme">
        <i class="ic i-sun"></i>
      </li>
      <li class="item search">
        <i class="ic i-search"></i>
      </li>
    </ul>
  </div>
</nav>

      </div>
      <div id="imgs" class="pjax">
          <img src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img5/v2-a98fa474f0b3430fc46b16455c2c6b4e_1440w.webp">
      </div>
    </header>
    <div id="waves">
      <svg class="waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
        <defs>
          <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z" />
        </defs>
        <g class="parallax">
          <use xlink:href="#gentle-wave" x="48" y="0" />
          <use xlink:href="#gentle-wave" x="48" y="3" />
          <use xlink:href="#gentle-wave" x="48" y="5" />
          <use xlink:href="#gentle-wave" x="48" y="7" />
        </g>
      </svg>
    </div>
    <main>
      <div class="inner">
        <div id="main" class="pjax">
          
  <div class="article wrap">
    
<div class="breadcrumb" itemscope itemtype="https://schema.org/BreadcrumbList">
<i class="ic i-home"></i>
<span><a href="/">首页</a></span>
</div>

    <article itemscope itemtype="http://schema.org/Article" class="post block" lang="zh-CN">
  <link itemprop="mainEntityOfPage" href="http://dodobird.top/2023/08/05/gemmini_mlir/">

  <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="image" content="/images/avatar.jpg">
    <meta itemprop="name" content="mariohong">
    <meta itemprop="description" content=", ">
  </span>

  <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="mariohong's blog">
  </span>

  <div class="body md" itemprop="articleBody">
    

    <h1 id="环境配置"><a class="markdownIt-Anchor" href="#环境配置">#</a> 环境配置</h1>
<h2 id="一-gemmini环境配置"><a class="markdownIt-Anchor" href="#一-gemmini环境配置">#</a> <strong>一、Gemmini 环境配置</strong></h2>
<h3 id="1配置chipyard环境"><a class="markdownIt-Anchor" href="#1配置chipyard环境">#</a> <strong>1. 配置 Chipyard 环境：</strong></h3>
<p>根据<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VjYi1iYXIvZ2VtbWluaQ==">安装提示</span>，必须在 linux 中进行。第一次没注意，使用 windows 结果卡在 “Collecting package metadata”。</p>
<p>由于 conda 和 git 之前已经安装过，现在只要安装 conda-lock。执行 “./build-setup.sh riscv-tools” 指令后会有漫长的等待。</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/1%E6%BC%AB%E9%95%BF%E7%AD%89%E5%BE%85.png" alt=""></p>
<p>中途虚拟机磁盘容量不足了，不得不再来一次。直接在 VMware 设置扩容是不够的，还要在虚拟机中设置文件分区大小。 建议磁盘空间 50G 以上！</p>
<p><strong>报错：./build-setup.sh riscv-tools 运行时报错重叠的输出路径</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/3%E9%87%8D%E5%8F%A0%E8%BE%93%E5%87%BA%E6%96%87%E4%BB%B6%E5%A4%B9.png" alt=""></p>
<p>重新安装无效，改 chipyard 版本无效，若暂且搁置后面能运行到第 4 步。</p>
<p>后来尝试在根目录下安装，结果出现一大堆警告，最后在 common.mk 的 380 行强行终止。</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/7%E5%BC%82%E5%B8%B8%E7%BB%88%E6%AD%A2.png" alt=""></p>
<p>此时再继续会导致 “make -C software/libgemmini install” 指令不通过。</p>
<p>解决方法：<span class="exturl" data-url="aHR0cDovL3huLS1pbml0LXN1Ym1vZHVsZXMtbm8tcmlzY3YtdG9vbHMtaGcxNGNvejNqbGw3aHZpNWk4NzJiLnNo">多运行几次 init-submodules-no-riscv-tools.sh</span> 和 <span class="exturl" data-url="aHR0cDovL2J1aWxkLXRvb2xjaGFpbi1leHRyYS5zaA==">build-toolchain-extra.sh</span> 两个脚本后再次尝试，发现正常了。</p>
<p>其中发现有因为网络问题无法连接的情况，科学 上网也没用。</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/8%E9%83%A8%E5%88%86%E5%8C%85%E6%97%A0%E6%B3%95%E4%B8%8B%E8%BD%BD.png" alt=""></p>
<p>不过好像不影响。</p>
<h3 id="2setting-up-gemmini"><a class="markdownIt-Anchor" href="#2setting-up-gemmini">#</a> <strong>2.Setting Up Gemmini</strong></h3>
<p>这一步很顺利，按流程即可。</p>
<h3 id="3building-gemmini-software"><a class="markdownIt-Anchor" href="#3building-gemmini-software">#</a> <strong>3.Building Gemmini Software</strong></h3>
<p>按照流程执行到 “./build.sh” 时，<strong>报错 “autoconf: 未找到命令”</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/4%E6%9C%AA%E6%89%BE%E5%88%B0%E5%91%BD%E4%BB%A4.png" alt=""></p>
<p>解决方法：安装缺少的依赖，输入 “sudo apt install -y autoconf”</p>
<h3 id="4building-gemmini-hardware-and-cycle-accurate-simulators"><a class="markdownIt-Anchor" href="#4building-gemmini-hardware-and-cycle-accurate-simulators">#</a> <strong>4.Building Gemmini Hardware and Cycle-Accurate Simulators</strong></h3>
<p>报错：环境变量 PATH 找不到 verilator</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/5%E6%8A%A5%E9%94%99.png" alt=""></p>
<p>解决方法：sudo apt-get install verilator</p>
<p>update：改 conda 环境</p>
<p><strong>报错：找不到 libriscv</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/6%E6%8A%A5%E9%94%99.png" alt=""></p>
<p>原因：可能是之前报错的指令 “./build-setup.sh riscv-tools” 导致，缺少某些包。重新加载 env.sh 无效</p>
<p>解决方法：发现并不是上述原因，是没有改 conda 环境，应该改成如下所示，之后的操作必须改 conda！</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/8b92e64c-3688-4b41-9d62-1b7ffd5ad00f.png" alt=""></p>
<h3 id="5building-gemmini-functional-simulators"><a class="markdownIt-Anchor" href="#5building-gemmini-functional-simulators">#</a> 5.<strong>Building Gemmini Functional Simulators</strong></h3>
<p><strong>报错：make 错误</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/make5b49209d-8b8c-4af7-860b-44d258b05ff4.png" alt=""></p>
<p>会影响 6 (2) 操作，若 6 (2) 报错找不到上图文件，4、5 可以多执行几次。注意 conda 环境。</p>
<h3 id="6run-simulators"><a class="markdownIt-Anchor" href="#6run-simulators">#</a> 6.<strong>Run Simulators</strong></h3>
<h4 id="1run-a-large-dnn-workload-in-the-functional-simulator"><a class="markdownIt-Anchor" href="#1run-a-large-dnn-workload-in-the-functional-simulator">#</a> （1）Run a large DNN workload in the functional simulator</h4>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/9%E6%AD%A3%E5%B8%B8%E8%BF%90%E8%A1%8C.png" alt=""></p>
<p>运行结果：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/10.png" alt=""></p>
<h4 id="2run-a-smaller-workload-in-baremetal-mode-on-a-cycle-accurate-simulator"><a class="markdownIt-Anchor" href="#2run-a-smaller-workload-in-baremetal-mode-on-a-cycle-accurate-simulator">#</a> （2）Run a smaller workload in baremetal mode, on a cycle-accurate simulator</h4>
<p><strong>报错：找不到文件</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/11.png" alt=""></p>
<p>解决方法：重复 4、5 中的操作，多 make 几次，会出现下面这个文件</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/13.png" alt=""></p>
<p>运行结果：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/14.png" alt=""></p>
<h4 id="3run-a-smaller-workload-with-the-proxy-kernel-on-a-cycle-accurate-simulator"><a class="markdownIt-Anchor" href="#3run-a-smaller-workload-with-the-proxy-kernel-on-a-cycle-accurate-simulator">#</a> （3）Run a smaller workload with the proxy-kernel, on a cycle accurate simulator</h4>
<p>运行结果：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/15.png" alt=""></p>
<h2 id="二-buddy-mlir环境配置"><a class="markdownIt-Anchor" href="#二-buddy-mlir环境配置">#</a> 二、buddy-mlir 环境配置</h2>
<h3 id="1llvmmlir-dependencies"><a class="markdownIt-Anchor" href="#1llvmmlir-dependencies">#</a> 1.LLVM/MLIR Dependencies</h3>
<p>安装 llvm 时报错：cmake 失败</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/16.png" alt=""></p>
<p>想办法重新装 llvm，结果又报错：用不了 Ninja</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/17.png" alt=""></p>
<p>解决方法：降低 cmake 版本无效，安装 ninja-build 后成功</p>
<p>报错：内存不足，build 被终止</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/18.png" alt=""></p>
<p>解决方法：限制进程数， <code>ninja -C build check-llvm -j4 </code> 限制 4 进程</p>
<p><strong>链接报错：</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/19.png" alt=""></p>
<p>解决方法：可能是子任务出错，重新跑一遍就行。</p>
<p>报错： <code>ctime:80:11: error: 'timespec_get' has not been declared in '::'</code></p>
<p>解决方法：<span class="exturl" data-url="aHR0cHM6Ly9yb290LWZvcnVtLmNlcm4uY2gvdC9lcnJvci10aW1lc3BlYy1nZXQtaGFzLW5vdC1iZWVuLWRlY2xhcmVkLXdpdGgtY29uZGEtcm9vdC1wYWNrYWdlLzQ1NzEyLzY=">论坛</span>上说是 conda 环境和系统环境冲突，尝试用 <code>conda upgrade -c conda-forge --all</code>  更新 conda 无效。搞到后来又发现环境不一致问题，服了。考虑到一开始用的是 miniconda3，最后改为安装 miniforge3 就不报错了。</p>
<h3 id="2clone-and-initialize"><a class="markdownIt-Anchor" href="#2clone-and-initialize">#</a> 2.<strong>Clone</strong> <strong>and Initialize</strong></h3>
<p>很顺利</p>
<h3 id="3build-and-test-llvmmlirclang"><a class="markdownIt-Anchor" href="#3build-and-test-llvmmlirclang">#</a> 3.<strong>Build and Test</strong> LLVM/MLIR/CLANG</h3>
<p>等待时间较长，还是一步安装的那个比较好 hh</p>
<p>其中运行  <code>ninja check-mlir check-clang</code>  时有一个没 pass</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/20.png" alt=""></p>
<p>解决方法还没找到。它是一个无关紧要的包，不影响后续流程。</p>
<p><strong>报错：CMakeLists.txt 不匹配</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/29.png" alt=""></p>
<p>解决方法：这是由于重复 cmake 且两次缓存不符导致的，删除 CMakeCache.txt 文件即可。</p>
<h3 id="4build-buddy-mlir"><a class="markdownIt-Anchor" href="#4build-buddy-mlir">#</a> 4.Build buddy-mlir</h3>
<p>后面的都能正常运行，最后一条测试 ninja check-buddy 结果：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/21.png" alt=""></p>
<h2 id="三-buddy-benchmark环境配置"><a class="markdownIt-Anchor" href="#三-buddy-benchmark环境配置">#</a> 三、buddy-benchmark 环境配置</h2>
<h3 id="1choose-and-build-dependencies"><a class="markdownIt-Anchor" href="#1choose-and-build-dependencies">#</a> 1.<strong>Choose and Build Dependencies</strong></h3>
<p>很顺利</p>
<h3 id="2gemmini-benchmark"><a class="markdownIt-Anchor" href="#2gemmini-benchmark">#</a> 2.<strong>Gemmini Benchmark</strong></h3>
<p><strong>报错：找不到 buddy-mlir 的包</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/22.png" alt=""></p>
<p>解决方法：添加一下环境变量</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/23.png" alt=""></p>
<p><strong>报错：找不到路径</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/25.png" alt=""></p>
<p>解决方法：上一步中的目录改成自己 build 的地址</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/26.png" alt=""></p>
<p><strong>报错：找不到 riscv64-unknown-linux-gnu-g++</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/24.png" alt=""></p>
<p>解决方法：换成 chipyard 中的 conda 环境就行</p>
<p><strong>报错：找不到头文件</strong></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/27.png" alt=""></p>
<p>解决方法：尝试从另一个文件中获取同名文件看看能不能用，能通过但是最后有一个其它地方报错了，说明不仅仅是缺少这一个头文件的问题，应该是之前的安装有些疏忽。换了 miniforge 环境，重复一遍 buddy-mlir 的安装，再走一遍，头文件就能找到了。</p>
<p>头文件解决后，ninja 时又出现如下报错：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/30.png" alt=""></p>
<p>解决方法：尝试过重装 chipyard、buddy-mlir、自行配置 llvm 均无效，最后在<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2J1ZGR5LWNvbXBpbGVyL2J1ZGR5LWJlbmNobWFyay9pc3N1ZXMvNDg="> issue</span> 中找到方案。需要安装 git lfs，保证 ResNet-101 被成功 clone，具体代码如下：</p>
<figure class="highlight shell"><figcaption data-lang="Bash"></figcaption><table><tr><td data-num="1"></td><td><pre><span class="token function">curl</span> <span class="token parameter variable">-s</span> https://packagecloud.io/install/repositories/github/git-lfs/script.deb.sh <span class="token operator">|</span> <span class="token function">sudo</span> <span class="token function">bash</span></pre></td></tr><tr><td data-num="2"></td><td><pre><span class="token function">sudo</span> <span class="token function">apt-get</span> <span class="token function">install</span> git-lfs</pre></td></tr><tr><td data-num="3"></td><td><pre><span class="token function">git</span> lfs <span class="token function">install</span></pre></td></tr></table></figure><p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/31.png" alt=""></p>
<p>重新 clone 一下 buddy-benchmark，发现这次可以运行了</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/32.png" alt=""></p>
<p>果然是缺少文件。</p>
<p>最后，修改一下 chipyard 中 GemminiCustomConfigs.scala 文件配置，将 baselineInferenceConfig 改为 defaultFpConfig，重新生成 spike。</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/33.png" alt=""></p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/34.png" alt=""></p>
<p>完结撒花～～～</p>
<h1 id="gemmini架构"><a class="markdownIt-Anchor" href="#gemmini架构">#</a> Gemmini 架构</h1>
<h2 id="一-gemmini概述"><a class="markdownIt-Anchor" href="#一-gemmini概述">#</a> 一、Gemmini 概述</h2>
<p>Gemmini 项目是一个全系统、全栈的 DNN 硬件探索和评估平台，使得我们能够深入了解系统和软件堆栈之间的相互作用对 DNN 性能的影响。结构图如下所示：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/image-20230811151747268.png" alt="image-20230811151747268"></p>
<p>Gemmini 使用 RISC-V 自定义指令实现 RoCC 加速器，其单元使用 Rocket 或 BOOM 块的 RoCC 端口，默认情况下通过系统总线连接到内存系统。</p>
<p>该加速器的核心是脉动阵列，主要用于执行矩阵乘法，支持输出平稳和权重平稳数据流。</p>
<p>阵列的输入和输出存储在由成组 SRAM 组成的显式管理暂存器中，由 DMA 加速暂存器数据和主存数据的传输。</p>
<p>此外，由于在处理权重平稳数据流时需要使用脉动阵列外部的累加器，所以需要添加一个配备加法器单元的最终 SRAM 组，这样脉动数组就能将结果存入任意地址的累加器或者从累加器读取数据。</p>
<h2 id="二-脉动阵列"><a class="markdownIt-Anchor" href="#二-脉动阵列">#</a> 二、脉动阵列</h2>
<p>脉动阵列是加速器的核心组成部分，结构如下：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/image-20230811151810137.png" alt="image-20230811151810137"></p>
<p>其主要参数有：</p>
<ol>
<li>脉动数组维度 (tileRows, tileColumns, meshRows, meshColumns)：脉动数组由 2 级层次结构组成，其中每个图块都是完全组合的，而图块网格在每个图块之间具有管道寄存器。</li>
<li>暂存器和累加器存储器参数 (sp_banks、sp_capacity、acc_capacity)：暂存器或累加器的总容量（单位 KB）</li>
<li>数据流参数 (dateflow)：确定 Gemmini 中的脉动数组是输出平稳还是重量平稳。</li>
<li>类型参数 (inputType、outputType、accType)：确定流经 Gemmini 加速器不同部分的数据类型，例如 8 位定点数、32 位整数等。</li>
<li>访问执行队列参数（ld_queue_length、st_queue_length、ex_queue_length、rob_entries）：为实现访问执行解耦，Gemmini 加速器具有加载指令队列、存储指令队列和执行指令队列。这些队列的相对大小决定了访问执行解耦的级别。</li>
<li>DMA 参数 (dma_maxbytes、dma_buswidth、mem_pipeline)：Gemmini 实现 DMA 将数据从主存储器移动到 Gemmini 暂存器，以及从 Gemmini 累加器移动到主存储器。这些 DMA 事务的大小由 DMA 参数决定。这些 DMA 参数与 Rocket Chip SoC 系统参数紧密耦合。</li>
</ol>
<p>脉动阵列中最基础的单元为 PE，功能是实现一维乘加运算。大量 PE 排列成方形，组成一个 Tile，Tile 之间彼此相连，两两之间有寄存器可以利用。计算前需要将数据存入脉动阵列或者周围（图中红线和蓝线所连接）的存储器中。</p>
<h2 id="三-软件部分"><a class="markdownIt-Anchor" href="#三-软件部分">#</a> 三、软件部分</h2>
<p>Gemmini 在配置指令、数据移动指令和矩阵乘法执行指令方面指定指令集。然后生成器将 Gemmini 自定义指令包装到 DNN 运算符中，相关宏定义可见 <code>software/gemmini-rocc-tests/include/gemmini.h</code> 。生成器还会根据参数生成 C 头文件，共同编译，调整库性能。此外，还可以通过 Microsoft ONNX-Runtime 框架的端口运行 ONNX 指定的神经网络。</p>
<h2 id="四-内存寻址"><a class="markdownIt-Anchor" href="#四-内存寻址">#</a> 四、内存寻址</h2>
<p>下图是 2*2 脉动阵列内存寻址的示意图。内存寻址按行进行，图中 Tile 一行有 2 个 PE 单元，则宽度 DIM 为 2。其中暂存器数据类型是 8 位的 int 值，累加器数据类型是 32 位的 int 值。</p>
<p>Gemmini 中的内存编码均为 32 位长，最高的 3 位是保留位，用于区分寻址累加器还是暂存器、写入时是覆盖还是继续累加、从何处读取数据、是否读取按比例缩小的数据等等。</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/image-20230811151824174.png" alt="image-20230811151824174"></p>
<h2 id="五-指令"><a class="markdownIt-Anchor" href="#五-指令">#</a> 五、指令</h2>
<p>这里只列举两个数据移动指令，更多的指令可以在<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3VjYi1iYXIvZ2VtbWluaQ=="> Gemmini 仓库</span>查看。</p>
<h3 id="i将数据从主存储器移至暂存器mvin"><a class="markdownIt-Anchor" href="#i将数据从主存储器移至暂存器mvin">#</a> （i）将数据从主存储器移至暂存器：mvin</h3>
<p>指令 <code>mvin rs1, rs2</code>  中，rs1 是加载到暂存器的虚拟 DRAM 地址，rs2 的 0<sub>31 位记录本地暂存器或累加器地址，32</sub>63 位记录要加载的行列数。即数据从 rs1 流向 rs2。其中加载的列数必须小于 Tile 中每行 TE 宽度 DIM，否则会拆分后分块加载。</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/image-20230811151834783.png" alt="image-20230811151834783"></p>
<h3 id="ii将数据从暂存器移至-l2drammvout"><a class="markdownIt-Anchor" href="#ii将数据从暂存器移至-l2drammvout">#</a> （ii）将数据从暂存器移至 L2/DRAM：mvout</h3>
<p>指令 <code>mvout rs1, rs2</code>  中，rs1 是从暂存器写入的虚拟 DRAM 地址，rs2 的 0<sub>31 位记录本地暂存器地址，32</sub>63 位同样记录加载行列数。即数据从 rs2 流向 rs1。</p>
<h1 id="mlir"><a class="markdownIt-Anchor" href="#mlir">#</a> MLIR</h1>
<h2 id="一-mlir概述"><a class="markdownIt-Anchor" href="#一-mlir概述">#</a> 一、MLIR 概述</h2>
<p>IR 是深度学习中模型的中间表示，包括算子和数据。但由于当前 IR 众多，造成维护和迁移的困难，而 MLIR 的出现就是为解决这个问题。</p>
<p>首先，MLIR 提出了 Dialect，即各种 IR 需要学习的语言，一旦某种 IR 学会这种语言，就可以基于这种语言将其重写为 MLIR。</p>
<p>此外，MLIR 还通过 Dialect 抽象出了多种不同级别的 MLIR，以应对 IR 跨度大的难题。例如源程序在经过语法树分析和 MLIR 分析后，得到的目标程序再作为下一次编译的源程序，通过 MLIR Dialect 多次下降，最终得到可执行的机器码，类似于渐进式学习。</p>
<h2 id="二-toy语言"><a class="markdownIt-Anchor" href="#二-toy语言">#</a> 二、toy 语言</h2>
<p>MLIR 中提供了 toy 语言以说明 MLIR 的执行流程，是验证和说明说用，因此语法和功能都非常简单。它是一种基于张量的语言，只支持 64 位浮点类型数据，适合于进行函数定义和数学计算。具体语法见<span class="exturl" data-url="aHR0cHM6Ly9tbGlyLmxsdm0ub3JnL2RvY3MvVHV0b3JpYWxzL1RveS9DaC0xLw==">官网</span>。</p>
<p>按照官网的语法教程看如下一个 MLIR 编译流程的例子，主要进行矩阵转置相乘。</p>
<pre><code># User defined generic function that operates on unknown shaped arguments.
def multiply_transpose(a, b) &#123;
  return transpose(a) * transpose(b);
&#125;

def main() &#123;
  # Define a variable `a` with shape &lt;2, 3&gt;, initialized with the literal value.
  var a = [[1, 2, 3], [4, 5, 6]];
  var b&lt;2, 3&gt; = [1, 2, 3, 4, 5, 6];

  # This call will specialize `multiply_transpose` with &lt;2, 3&gt; for both
  # arguments and deduce a return type of &lt;3, 2&gt; in initialization of `c`.
  var c = multiply_transpose(a, b);

  # A second call to `multiply_transpose` with &lt;2, 3&gt; for both arguments will
  # reuse the previously specialized and inferred version and return &lt;3, 2&gt;.
  var d = multiply_transpose(b, a);

  # A new call with &lt;3, 2&gt; (instead of &lt;2, 3&gt;) for both dimensions will
  # trigger another specialization of `multiply_transpose`.
  var e = multiply_transpose(b, c);

  # Finally, calling into `multiply_transpose` with incompatible shape will
  # trigger a shape inference error.
  var f = multiply_transpose(transpose(a), c);
&#125;
</code></pre>
<p>该程序生成 AST 再生成初级 MLIR 如下：</p>
<pre><code class="language-Python">module  &#123;
  func @multiply_transpose(%arg0: tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:4:1), %arg1: tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:4:1)) -&gt; tensor&lt;*xf64&gt; &#123;
    %0 = toy.transpose(%arg0 : tensor&lt;*xf64&gt;) to tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:5:10)
    %1 = toy.transpose(%arg1 : tensor&lt;*xf64&gt;) to tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:5:25)
    %2 = toy.mul %0, %1 : tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:5:25)
    toy.return %2 : tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:5:3)
  &#125; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:4:1)
  func @main() &#123;
    %0 = toy.constant dense&lt;[[1.000000e+00, 2.000000e+00, 3.000000e+00], [4.000000e+00, 5.000000e+00, 6.000000e+00]]&gt; : tensor&lt;2x3xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:9:17)
    %1 = toy.reshape(%0 : tensor&lt;2x3xf64&gt;) to tensor&lt;2x3xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:9:3)
    %2 = toy.constant dense&lt;[1.000000e+00, 2.000000e+00, 3.000000e+00, 4.000000e+00, 5.000000e+00, 6.000000e+00]&gt; : tensor&lt;6xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:10:17)
    %3 = toy.reshape(%2 : tensor&lt;6xf64&gt;) to tensor&lt;2x3xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:10:3)
    %4 = toy.generic_call @multiply_transpose(%1, %3) : (tensor&lt;2x3xf64&gt;, tensor&lt;2x3xf64&gt;) -&gt; tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:11:11)
    %5 = toy.generic_call @multiply_transpose(%3, %1) : (tensor&lt;2x3xf64&gt;, tensor&lt;2x3xf64&gt;) -&gt; tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:12:11)
    toy.print %5 : tensor&lt;*xf64&gt; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:13:3)
    toy.return loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:8:1)
  &#125; loc(&quot;../../mlir/test/Examples/Toy/Ch2/codegen.toy&quot;:8:1)
&#125; loc(unknown)
</code></pre>
<p>代码中红色部分是冗余的 reshape 操作，需要通过 Pass 来识别和优化冗余。此时有两种途径，一种是使用 C++ 编写匹配和重写函数来消除冗余，另一种是采用 DRR 自动生成函数。</p>
<p>优化后 main 函数部分表达式如下，可见已经非常简化了。</p>
<pre><code class="language-Python">module  &#123;
  func @main() &#123;
    %0 = toy.constant dense&lt;[[1.000000e+00, 2.000000e+00, 3.000000e+00], [4.000000e+00, 5.000000e+00, 6.000000e+00]]&gt; : tensor&lt;2x3xf64&gt;
    %1 = toy.transpose(%0 : tensor&lt;2x3xf64&gt;) to tensor&lt;3x2xf64&gt;
    %2 = toy.mul %1, %1 : tensor&lt;3x2xf64&gt;
    toy.print %2 : tensor&lt;3x2xf64&gt;
    toy.return
  &#125;
&#125;
</code></pre>
<p>该段代码还是比较高层的，还可以继续部分 Lowering，混合不同的 Dialect Lowering 到 LLVM IR。</p>
<p>总体流程可以如下表示：</p>
<p><img data-src="https://dodobird-blog.oss-cn-shanghai.aliyuncs.com/img3/image-20230811151931844.png" alt="image-20230811151931844"></p>
<h2 id="三-gemmini方言分析"><a class="markdownIt-Anchor" href="#三-gemmini方言分析">#</a> 三、Gemmini 方言分析</h2>
<p>由于指令较多，这里只选取几个详细讲解。</p>
<h3 id="1mvin-mvout"><a class="markdownIt-Anchor" href="#1mvin-mvout">#</a> （1）mvin-mvout</h3>
<pre><code class="language-Makefile">mvin-mvout-run:
        @$&#123;BUDDY_OPT&#125; ./mvin-mvout.mlir -lower-gemmini | \
        $&#123;BUDDY_TRANSLATE&#125; --buddy-to-llvmir | \
        $&#123;BUDDY_LLC&#125; -filetype=obj -mtriple=riscv64 \
                -mattr=+buddyext,+D -float-abi=hard \
                -o log.o
        @riscv64-unknown-linux-gnu-gcc log.o -O2 -static -o a.out
        @spike --extension=gemmini pk a.out
</code></pre>
<p>在上述代码的第 2 行，操作是执行了 mvin-mvout.mlir，然后有一个 lower 操作，下降到 llvmir。比较简单的例子都是这样的结构，只是前面操作的 mlir 文件有所不同。在此打开 mvin-mvout.mlir 文件。</p>
<pre><code>// RUN: buddy-opt %s \
// RUN:     --lower-gemmini | \
// RUN: FileCheck %s

memref.global &quot;private&quot; @gv : memref&lt;2x16xi8&gt; = dense&lt;[[0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15],
                                                       [16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31]]&gt;

func.func @main() -&gt; i64 &#123;
  %0 = arith.constant 0 : i64
  %stride16 = arith.constant 16 : i64
  %stride8 = arith.constant 8 : i64
  %spadAddr = arith.constant 0 : i64 //暂存器地址
  %arrayA = memref.get_global @gv : memref&lt;2x16xi8&gt;   //获取全局变量
  %arrayB = memref.alloc() : memref&lt;3x16xi8&gt;  //分配内存
  %arrayC = memref.alloc() : memref&lt;2x8xi8&gt;
  gemmini.print %arrayB : memref&lt;3x16xi8&gt;
  gemmini.print %arrayC : memref&lt;2x8xi8&gt;
  // CHECK: &quot;gemmini.intr.config_st&quot;
  // The mvout op's stride is 16.
  gemmini.config_st %stride16 : i64    //确定mvout的步长16
  // CHECK: &quot;gemmini.intr.config_ld&quot;
  // The mvin op's stride is 16 
  gemmini.config_ld %stride16 : i64    //确定mvin的步长16
  // CHECK: &quot;gemmini.intr.mvin&quot;
  gemmini.mvin %arrayA %spadAddr : memref&lt;2x16xi8&gt; i64
  // CHECK: &quot;gemmini.intr.mvout&quot;
  gemmini.mvout %arrayB %spadAddr : memref&lt;3x16xi8&gt; i64
  // CHECK: &quot;gemmini.intr.config_st&quot;
  // The mvout op's stride is 8 
  gemmini.config_st %stride8 : i64    //步长为8,因为C矩阵大小为2*8,按行寻址,DIM为每行的PE数
  // CHECK: &quot;gemmini.intr.mvout&quot;
  gemmini.mvout %arrayC %spadAddr : memref&lt;2x8xi8&gt; i64 
  gemmini.print %arrayB : memref&lt;3x16xi8&gt;
  gemmini.print %arrayC : memref&lt;2x8xi8&gt;
  return %0 : i64
&#125;
</code></pre>
<p>从上往下，第 5 行是全局变量的声明，然后 main 函数中有三个矩阵，分别是 A、B、C，其中 A 赋值为全局变量，B、C 仅分配了内存。然后在第 20 行有一条 config_st 指令，需要查阅 td 文件。在 td 文件中找到 config_st 的定义：</p>
<pre><code class="language-Plain">def ConfigStOp : Gemmini_Op&lt;&quot;config_st&quot;&gt; &#123;
  let summary = &quot;Config store operation&quot;;
  let description = [&#123;
    TODO: consider the attribute type according to Gemmini spec.
  &#125;];
  let arguments = (ins I64:$stride,
                       DefaultValuedAttr&lt;I64Attr, &quot;0&quot;&gt;:$activation,
                       DefaultValuedAttr&lt;F32Attr, &quot;1.0&quot;&gt;:$scale);  
  let assemblyFormat = &quot;$stride attr-dict `:` type($stride)&quot;;
&#125;
</code></pre>
<p>从 description 中可以看出，这条指令用于根据特定的 Gemmini 确定 mvin 步长参数。</p>
<p>第 23 行的 config_ld 同理也是确定步长的，只不过是确定 mvout 的步长而已。</p>
<p>接下来就是矩阵 A 数据移动到暂存器，暂存器数据移动到矩阵 B 的过程。当暂存器中的数据移动到矩阵 C 时，需要指定步长为 8，因为 C 矩阵的大小为 2*8，根据之前所说的按行寻址模式，宽度为 8。当然，宽度不能超过脉动矩阵的最大宽度，即一个 Tile 中一行的 PE 元件数量，否则会发生切割后分块传输。</p>
<p>最后是一些打印过程，不再赘述。</p>
<h3 id="2matmul-os"><a class="markdownIt-Anchor" href="#2matmul-os">#</a> （2）matmul-os</h3>
<pre><code>matmul-os-run:
        @$&#123;BUDDY_OPT&#125; ./matmul-os.mlir -lower-gemmini | \
        $&#123;BUDDY_TRANSLATE&#125; --buddy-to-llvmir | \
        $&#123;BUDDY_LLC&#125; -filetype=obj -mtriple=riscv64 \
                -mattr=+buddyext,+D -float-abi=hard \
                -o log.o
        @riscv64-unknown-linux-gnu-gcc log.o -O2 -static -o a.out
        @spike --extension=gemmini pk a.out
</code></pre>
<p>这是一个矩阵相乘，并且输出稳定的例子。同样地，打开 matmul-os.mlir 文件如下：</p>
<pre><code>// RUN: buddy-opt %s \
// RUN:     --lower-gemmini | \
// RUN: FileCheck %s

memref.global &quot;private&quot; @gv1 : memref&lt;4x4xi8&gt; = dense&lt;[[1, 2, 3, 4],
                                                       [5, 6, 7, 8],
                                                       [9, 10, 11, 12],
                                                       [13, 14, 15, 16]]&gt;
memref.global &quot;private&quot; @gv2 : memref&lt;4x4xi8&gt; = dense&lt;[[1, 1, 1, 1],
                                                       [1, 1, 1, 1],
                                                       [1, 1, 1, 1],
                                                       [1, 1, 1, 1]]&gt;

func.func @main() -&gt; i64 &#123;
  %in = memref.get_global @gv1 : memref&lt;4x4xi8&gt;   //获取全局变量
  %identity = memref.get_global @gv2 : memref&lt;4x4xi8&gt;  //获取全局变量
  %out = memref.alloc() : memref&lt;4x4xi8&gt;  //分配内存
  gemmini.print %out : memref&lt;4x4xi8&gt; 
  %inSpAddr = arith.constant 0 : i64   //指定输入暂存器的地址
  %outSpAddr = arith.constant 4 : i64   //指定输出暂存器的地址
  %identitySpAddr = arith.constant 8 : i64
  %cst4 = arith.constant 4 : i64
  %cst0 = arith.constant 0 : i64
  // CHECK: &quot;gemmini.intr.config_st&quot;
  gemmini.config_st %cst4 : i64  //指定输入暂存器的步长
  // CHECK: &quot;gemmini.intr.config_ld&quot;
  gemmini.config_ld %cst4 : i64  //指定输出暂存器的步长
  // CHECK: &quot;gemmini.intr.mvin&quot;
  gemmini.mvin %in %inSpAddr : memref&lt;4x4xi8&gt; i64
  // CHECK: &quot;gemmini.intr.config_ld&quot;
  gemmini.config_ld %cst4 : i64
  // CHECK: &quot;gemmini.intr.mvin&quot;
  gemmini.mvin %identity %identitySpAddr : memref&lt;4x4xi8&gt; i64
  // CHECK: &quot;gemmini.intr.config_ex&quot;
  gemmini.config_ex &#123;dataflow = 0 &#125;   //配置执行管道
  // CHECK: &quot;gemmini.intr.preload&quot;
  gemmini.preload_zeros %outSpAddr %cst4 %cst4 : i64 i64 i64  //预加载为0
  // CHECK: &quot;gemmini.intr.compute_preloaded&quot;
  //执行矩阵乘法
  gemmini.compute_preloaded %inSpAddr %identitySpAddr %cst4 %cst4 %cst4 %cst4 : i64 i64 i64 i64 i64 i64
  // CHECK: &quot;gemmini.intr.mvout&quot;
  gemmini.mvout %out %outSpAddr : memref&lt;4x4xi8&gt; i64  //输出到主存
  gemmini.print %out : memref&lt;4x4xi8&gt; 
  return %cst0 : i64
&#125;
</code></pre>
<p>其中，config_ex 指令用于配置执行管道，包括配置数据流是输出稳定还是权重稳定，是否转置等等。值得一提的是，转置操作也是直接通过 config_ex 指令实现的。preload_zeros 指令用于在输出的暂存器地址上预置 0，因为默认是会将计算结果直接加上当前数。compute_preloaded 指令则是用于计算矩阵相乘的结果，最后从 outAddr 取出计算结果。</p>

  </div>

   <footer>

    <div class="meta">
  <span class="item">
    <span class="icon">
      <i class="ic i-calendar-check"></i>
    </span>
    <span class="text">更新于</span>
    <time title="修改时间：2023-10-15 17:00:01" itemprop="dateModified" datetime="2023-10-15T17:00:01+08:00">2023-10-15</time>
  </span>
</div>

      

<div id="copyright">
<ul>
  <li class="author">
    <strong>本文作者： </strong>mariohong <i class="ic i-at"><em>@</em></i>mariohong's blog
  </li>
  <li class="link">
    <strong>本文链接：</strong>
    <a href="http://dodobird.top/2023/08/05/gemmini_mlir/" title="gemmini+mlir环境搭建与架构认识">http://dodobird.top/2023/08/05/gemmini_mlir/</a>
  </li>
  <li class="license">
    <strong>版权声明： </strong>本站所有文章除特别声明外，均采用 <span class="exturl" data-url="aHR0cHM6Ly9jcmVhdGl2ZWNvbW1vbnMub3JnL2xpY2Vuc2VzL2J5LW5jLXNhLzQuMC9kZWVkLnpo"><i class="ic i-creative-commons"><em>(CC)</em></i>BY-NC-SA</span> 许可协议。转载请注明出处！
  </li>
</ul>
</div>

  </footer>

</article>

  </div>
  

<div class="post-nav">
    <div class="item left">
      

  <a href="/2023/05/22/CSAPP_lab3/" itemprop="url" rel="prev" data-background-image="https:&#x2F;&#x2F;dodobird-blog.oss-cn-shanghai.aliyuncs.com&#x2F;v2-2d757602df79fb323c615c85298e25b3_r.jpg" title="计算机系统基础lab3">
  <span class="type">上一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>计算机系统基础lab3</h3>
  </a>

    </div>
    <div class="item right">
      

  <a href="/2023/08/19/CMU15445_p1/" itemprop="url" rel="next" data-background-image="https:&#x2F;&#x2F;dodobird-blog.oss-cn-shanghai.aliyuncs.com&#x2F;bustub-whiteborder.svg" title="CMU15-445#project1">
  <span class="type">下一篇</span>
  <span class="category"><i class="ic i-flag"></i> </span>
  <h3>CMU15-445#project1</h3>
  </a>

    </div>
</div>

  
  <div class="wrap" id="comments"></div>


        </div>
        <div id="sidebar">
          

<div class="inner">

  <div class="panels">
    <div class="inner">
      <div class="contents panel pjax" data-title="文章目录">
          <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.</span> <span class="toc-text"> 环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-gemmini%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.1.</span> <span class="toc-text"> 一、Gemmini 环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1%E9%85%8D%E7%BD%AEchipyard%E7%8E%AF%E5%A2%83"><span class="toc-number">1.1.1.</span> <span class="toc-text"> 1. 配置 Chipyard 环境：</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2setting-up-gemmini"><span class="toc-number">1.1.2.</span> <span class="toc-text"> 2.Setting Up Gemmini</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3building-gemmini-software"><span class="toc-number">1.1.3.</span> <span class="toc-text"> 3.Building Gemmini Software</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4building-gemmini-hardware-and-cycle-accurate-simulators"><span class="toc-number">1.1.4.</span> <span class="toc-text"> 4.Building Gemmini Hardware and Cycle-Accurate Simulators</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5building-gemmini-functional-simulators"><span class="toc-number">1.1.5.</span> <span class="toc-text"> 5.Building Gemmini Functional Simulators</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#6run-simulators"><span class="toc-number">1.1.6.</span> <span class="toc-text"> 6.Run Simulators</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1run-a-large-dnn-workload-in-the-functional-simulator"><span class="toc-number">1.1.6.1.</span> <span class="toc-text"> （1）Run a large DNN workload in the functional simulator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2run-a-smaller-workload-in-baremetal-mode-on-a-cycle-accurate-simulator"><span class="toc-number">1.1.6.2.</span> <span class="toc-text"> （2）Run a smaller workload in baremetal mode, on a cycle-accurate simulator</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3run-a-smaller-workload-with-the-proxy-kernel-on-a-cycle-accurate-simulator"><span class="toc-number">1.1.6.3.</span> <span class="toc-text"> （3）Run a smaller workload with the proxy-kernel, on a cycle accurate simulator</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-buddy-mlir%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.2.</span> <span class="toc-text"> 二、buddy-mlir 环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1llvmmlir-dependencies"><span class="toc-number">1.2.1.</span> <span class="toc-text"> 1.LLVM&#x2F;MLIR Dependencies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2clone-and-initialize"><span class="toc-number">1.2.2.</span> <span class="toc-text"> 2.Clone and Initialize</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3build-and-test-llvmmlirclang"><span class="toc-number">1.2.3.</span> <span class="toc-text"> 3.Build and Test LLVM&#x2F;MLIR&#x2F;CLANG</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4build-buddy-mlir"><span class="toc-number">1.2.4.</span> <span class="toc-text"> 4.Build buddy-mlir</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-buddy-benchmark%E7%8E%AF%E5%A2%83%E9%85%8D%E7%BD%AE"><span class="toc-number">1.3.</span> <span class="toc-text"> 三、buddy-benchmark 环境配置</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1choose-and-build-dependencies"><span class="toc-number">1.3.1.</span> <span class="toc-text"> 1.Choose and Build Dependencies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2gemmini-benchmark"><span class="toc-number">1.3.2.</span> <span class="toc-text"> 2.Gemmini Benchmark</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#gemmini%E6%9E%B6%E6%9E%84"><span class="toc-number">2.</span> <span class="toc-text"> Gemmini 架构</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-gemmini%E6%A6%82%E8%BF%B0"><span class="toc-number">2.1.</span> <span class="toc-text"> 一、Gemmini 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-%E8%84%89%E5%8A%A8%E9%98%B5%E5%88%97"><span class="toc-number">2.2.</span> <span class="toc-text"> 二、脉动阵列</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-%E8%BD%AF%E4%BB%B6%E9%83%A8%E5%88%86"><span class="toc-number">2.3.</span> <span class="toc-text"> 三、软件部分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9B%9B-%E5%86%85%E5%AD%98%E5%AF%BB%E5%9D%80"><span class="toc-number">2.4.</span> <span class="toc-text"> 四、内存寻址</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%94-%E6%8C%87%E4%BB%A4"><span class="toc-number">2.5.</span> <span class="toc-text"> 五、指令</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#i%E5%B0%86%E6%95%B0%E6%8D%AE%E4%BB%8E%E4%B8%BB%E5%AD%98%E5%82%A8%E5%99%A8%E7%A7%BB%E8%87%B3%E6%9A%82%E5%AD%98%E5%99%A8mvin"><span class="toc-number">2.5.1.</span> <span class="toc-text"> （i）将数据从主存储器移至暂存器：mvin</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ii%E5%B0%86%E6%95%B0%E6%8D%AE%E4%BB%8E%E6%9A%82%E5%AD%98%E5%99%A8%E7%A7%BB%E8%87%B3-l2drammvout"><span class="toc-number">2.5.2.</span> <span class="toc-text"> （ii）将数据从暂存器移至 L2&#x2F;DRAM：mvout</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#mlir"><span class="toc-number">3.</span> <span class="toc-text"> MLIR</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80-mlir%E6%A6%82%E8%BF%B0"><span class="toc-number">3.1.</span> <span class="toc-text"> 一、MLIR 概述</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BA%8C-toy%E8%AF%AD%E8%A8%80"><span class="toc-number">3.2.</span> <span class="toc-text"> 二、toy 语言</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%89-gemmini%E6%96%B9%E8%A8%80%E5%88%86%E6%9E%90"><span class="toc-number">3.3.</span> <span class="toc-text"> 三、Gemmini 方言分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1mvin-mvout"><span class="toc-number">3.3.1.</span> <span class="toc-text"> （1）mvin-mvout</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2matmul-os"><span class="toc-number">3.3.2.</span> <span class="toc-text"> （2）matmul-os</span></a></li></ol></li></ol></li></ol>
      </div>
      <div class="related panel pjax" data-title="系列文章">
      </div>
      <div class="overview panel" data-title="站点概览">
        <div class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <img class="image" itemprop="image" alt="mariohong"
      data-src="/images/avatar.jpg">
  <p class="name" itemprop="name">mariohong</p>
  <div class="description" itemprop="description"></div>
</div>

<nav class="state">
    <div class="item posts">
      <a href="/archives/">
        <span class="count">13</span>
        <span class="name">文章</span>
      </a>
    </div>
</nav>

<div class="social">
      <span class="exturl item github" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvZG9iaXJkMjMz" title="https:&#x2F;&#x2F;github.com&#x2F;dodobird233"><i class="ic i-github"></i></span>
      <span class="exturl item about" data-url="aHR0cHM6Ly9naXRodWIuY29tL2RvZG9iaXJkMjMz" title="https:&#x2F;&#x2F;github.com&#x2F;dodobird233"><i class="ic i-address-card"></i></span>
      <span class="exturl item email" data-url="bWFpbHRvOnp0aG9uZ0BodXN0LmVkdS5jbg==" title="mailto:zthong@hust.edu.cn"><i class="ic i-envelope"></i></span>
</div>

<ul class="menu">
  
    
  <li class="item">
    <a href="/" rel="section"><i class="ic i-home"></i>首页</a>
  </li>

    
  <li class="item">
    <a href="/about/" rel="section"><i class="ic i-user"></i>关于</a>
  </li>

        
  <li class="item dropdown">
      <a href="javascript:void(0);"><i class="ic i-feather"></i>文章</a>
    <ul class="submenu">

        
  <li class="item">
    <a href="/archives/" rel="section"><i class="ic i-list-alt"></i>归档</a>
  </li>

  </ul>

</ul>

      </div>
    </div>
  </div>

  <ul id="quick">
    <li class="prev pjax">
        <a href="/2023/05/22/CSAPP_lab3/" rel="prev" title="上一篇"><i class="ic i-chevron-left"></i></a>
    </li>
    <li class="up"><i class="ic i-arrow-up"></i></li>
    <li class="down"><i class="ic i-arrow-down"></i></li>
    <li class="next pjax">
        <a href="/2023/08/19/CMU15445_p1/" rel="next" title="下一篇"><i class="ic i-chevron-right"></i></a>
    </li>
    <li class="percent"></li>
  </ul>
</div>


        </div>
        <div class="dimmer"></div>
      </div>
    </main>
    <footer id="footer">
      <div class="inner">
        <div class="widgets">
          

        </div>
        <div class="status">
  <div class="copyright">
    
    &copy; 2021 – 
    <span itemprop="copyrightYear">2025</span>
    <span class="with-love">
      <i class="ic i-sakura rotate"></i>
    </span>
    <span class="author" itemprop="copyrightHolder">mariohong @ mariohong's blog</span>
  </div>
  <div class="powered-by">
    基于 <span class="exturl" data-url="aHR0cHM6Ly9oZXhvLmlv">Hexo</span> & Theme.<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL2FtZWhpbWUvaGV4by10aGVtZS1zaG9rYQ==">Shoka</span>
  </div>
</div>

      </div>
    </footer>
  </div>
<script data-config type="text/javascript">
  var LOCAL = {
    path: '2023/08/05/gemmini_mlir/',
    favicon: {
      show: "mario's blog",
      hide: "mario's blog"
    },
    search : {
      placeholder: "文章搜索",
      empty: "关于 「 ${query} 」，什么也没搜到",
      stats: "${time} ms 内找到 ${hits} 条结果"
    },
    valine: true,fancybox: true,
    copyright: '复制成功，转载请遵守 <i class="ic i-creative-commons"></i>BY-NC-SA 协议。',
    ignores : [
      function(uri) {
        return uri.includes('#');
      },
      function(uri) {
        return new RegExp(LOCAL.path+"$").test(uri);
      }
    ]
  };
</script>

<script src="https://cdn.polyfill.io/v2/polyfill.js"></script>

<script src="//cdn.jsdelivr.net/combine/npm/pace-js@1.0.2/pace.min.js,npm/pjax@0.2.8/pjax.min.js,npm/whatwg-fetch@3.4.0/dist/fetch.umd.min.js,npm/animejs@3.2.0/lib/anime.min.js,npm/algoliasearch@4/dist/algoliasearch-lite.umd.js,npm/instantsearch.js@4/dist/instantsearch.production.min.js,npm/lozad@1/dist/lozad.min.js,npm/quicklink@2/dist/quicklink.umd.js"></script>

<script src="/js/app.js?v=0.2.5"></script>




</body>
</html>
